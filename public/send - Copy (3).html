<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envoyer un bon d'achat - Nimwema</title>
    <meta name="description" content="Envoyez un bon d'achat alimentaire via Nimwema">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/send.css">
	<link rel="stylesheet" href="/css/flexpay-popup.css">
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <!-- Top Bar: Language Selector + Login -->
        <div class="header-top">
            <div class="language-selector">
                <button class="lang-btn active" data-lang="fr">FR</button>
                <button class="lang-btn" data-lang="ln">LN</button>
                <button class="lang-btn" data-lang="en">EN</button>
            </div>
            <button class="login-btn" onclick="window.location.href='/login.html'">
                <span data-i18n="login">Connexion</span> / <span data-i18n="welcome">Bienvenue</span>
            </button>
        </div>
        
        <!-- Main Header: Logo + Menu -->
        <div class="header-main">
            <a href="/" class="logo">
                NIM<span class="w">W</span>EMA
            </a>
            <button class="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="section">
        <div class="container container-narrow">
            <!-- Page Header -->
            <div class="page-header">
                <h1 data-i18n="send_voucher_title">Envoyer un bon d'achat</h1>
                <p class="text-small" data-i18n="send_voucher_subtitle">
                    Choisissez le montant et envoyez un bon d'achat √† vos proches
                </p>
            </div>

            <!-- Send Form -->
            <form id="sendVoucherForm" class="form-card">
                <!-- Currency Selection -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="currency_selection">Devise</h3>
                    
                    <div class="currency-selector-group">
                        <button type="button" class="currency-btn active" data-currency="USD" onclick="selectCurrency('USD')">
                            <span class="currency-symbol">$</span>
                            <span class="currency-name">USD</span>
                        </button>
                        <button type="button" class="currency-btn" data-currency="CDF" onclick="selectCurrency('CDF')">
                            <span class="currency-symbol">FC</span>
                            <span class="currency-name">CDF</span>
                        </button>
                    </div>
                    
                    <div class="exchange-rate-display" id="exchangeRateDisplay">
                        <small data-i18n="exchange_rate">Taux de change:</small>
                        <strong id="exchangeRateText">1 USD = 2,800 CDF</strong>
                    </div>
                </div>

                <!-- Amount Selection -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="amount_selection">Montant</h3>
                    
                    <div class="amount-preset-grid" id="amountPresetGrid">
                        <!-- Preset buttons will be generated by JavaScript -->
                    </div>
                    
                    <div class="form-group">
                        <label for="customAmount" class="form-label">
                            <span data-i18n="custom_amount">Montant personnalis√©</span>
                        </label>
                        <div class="amount-input-group">
                            <span class="amount-currency" id="amountCurrencySymbol">$</span>
                            <input 
                                type="number" 
                                id="customAmount" 
                                name="customAmount" 
                                class="form-input amount-input"
                                min="1"
                                step="1"
                                placeholder="0">
                            <span class="amount-equivalent" id="amountEquivalent"></span>
                        </div>
                        <div class="form-helper" data-i18n="amount_helper_send">
                            S√©lectionnez un montant pr√©d√©fini ou entrez un montant personnalis√©
                        </div>
                    </div>
                </div>

                <!-- Quantity Selection -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="quantity_selection">Quantit√©</h3>
                    
                    <div class="form-group">
                        <label for="quantity" class="form-label">
                            <span data-i18n="number_of_vouchers">Nombre de bons</span>
                            <span class="required">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="quantity" 
                            name="quantity" 
                            class="form-input" 
                            required
                            min="1"
                            max="50"
                            value="1"
                            onchange="updateTotalAmount()">
                        <div class="form-helper" data-i18n="quantity_helper">
                            Nombre de bons d'achat √† cr√©er (maximum 50)
                        </div>
                    </div>
                    
                    <div class="total-amount-display">
                        <div class="total-label" data-i18n="total_amount">Montant total:</div>
                        <div class="total-value" id="totalAmountDisplay">$0</div>
                    </div>
                </div>

                <!-- Recipients Selection -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="recipients_selection">Destinataires</h3>
                    
                    <div class="radio-group">
                        <!-- From Waiting List -->
                        <label class="radio-label">
                            <input 
                                type="radio" 
                                name="recipientType" 
                                value="waiting_list"
                                onchange="toggleRecipientFields()">
                            <span class="radio-custom"></span>
                            <span class="radio-text">
                                <strong data-i18n="from_waiting_list">Depuis la liste d'attente</strong>
                                <small data-i18n="from_waiting_list_desc">Choisir des demandes en attente</small>
                            </span>
                        </label>

                        <!-- Specific Recipients -->
                        <label class="radio-label">
                            <input 
                                type="radio" 
                                name="recipientType" 
                                value="specific"
                                checked
                                onchange="toggleRecipientFields()">
                            <span class="radio-custom"></span>
                            <span class="radio-text">
                                <strong data-i18n="specific_recipients">Destinataires sp√©cifiques</strong>
                                <small data-i18n="specific_recipients_desc">Entrer les num√©ros manuellement</small>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Waiting List Selection (Hidden by default) -->
                <div id="waitingListSection" class="form-section hidden">
                    <h3 class="form-section-title" data-i18n="select_from_waiting_list">S√©lectionner depuis la liste d'attente</h3>
                    
                    <div id="waitingListContainer" class="waiting-list-container">
                        <!-- Waiting list items will be loaded here -->
                        <div class="loading-state">
                            <p data-i18n="loading">Chargement...</p>
                        </div>
                    </div>
                </div>

                <!-- Specific Recipients Section (Visible by default) -->
                <div id="specificRecipientsSection" class="form-section">
                    <h3 class="form-section-title" data-i18n="enter_recipients">Entrer les destinataires</h3>
                    
                    <div class="recipients-info-box">
                        <p>
                            <span data-i18n="recipients_info_text">Vous pouvez entrer jusqu'√† 50 num√©ros maximum par op√©ration.</span>
                            <span id="batchInfo" class="hidden">
                                <span data-i18n="batch_info_text">Vous devrez entrer</span> 
                                <strong id="batchCount">0</strong> 
                                <span data-i18n="batch_info_text2">lot(s) de num√©ros.</span>
                            </span>
                        </p>
                    </div>
                    
                    <div id="recipientsInputContainer">
                        <!-- Recipient inputs will be generated here -->
                    </div>
                    
                    <button type="button" class="btn btn-secondary" onclick="addRecipientField()" id="addRecipientBtn">
                        ‚ûï <span data-i18n="add_recipient">Ajouter un destinataire</span>
                    </button>
                </div>

                <!-- Sender Options -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="sender_options">Options d'envoi</h3>
                    
                    <div class="form-group">
                        <label for="senderName" class="form-label">
                            <span data-i18n="your_name">Votre nom</span>
                            <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="senderName" 
                            name="senderName" 
                            class="form-input" 
                            required
                            placeholder="Votre nom complet">
                    </div>
					
					
					
					
					
					
					
					
					<div class="form-group">
                        <label for="senderName" class="form-label">
                            <span data-i18n="your_mobile">Votre T√©l√©phone (sera utilis√© en cas de payment Mobile Money</span>
                            <span class="required">*</span>
                        </label>
					<input type="tel" id="senderPhone" name="senderPhone"
       class="form-input"
       placeholder="+243XXXXXXXXX"
       inputmode="tel" autocomplete="tel" >
<p class="text-xs text-gray-500 mt-1">Format conseill√© : +243812345678 (E.164)</p>
</div>

                        <div class="form-group" id="accountFields" style="display: none;">
                            <label for="senderEmail" class="form-label">
                                <span data-i18n="your_email">Votre Email</span>
                                <span class="required">*</span>
                            </label>
                            <input type="email" id="senderEmail" name="senderEmail"
                                class="form-input"
                                placeholder="votre@email.com"
                                autocomplete="email" >
                        </div>

                        <div class="form-group" id="passwordFields" style="display: none;">
                            <label for="senderPassword" class="form-label">
                                <span data-i18n="your_password">Mot de passe</span>
                                <span class="required">*</span>
                            </label>
                            <div class="password-input-container">
                                <input type="password" id="senderPassword" name="senderPassword"
                                    class="form-input"
                                    placeholder="Choisissez un mot de passe"
                                    autocomplete="new-password" >
                                <button type="button" class="password-toggle" onclick="togglePassword()">
                                    <i class="eye-icon">üëÅÔ∏è</i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Ce mot de passe vous servira √† vous connecter plus tard</p>
                        </div>

					
					
					
					
					
					
					
					
					
					
					
					
					
					
                    
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="hideIdentity" name="hideIdentity">
                            <span class="checkbox-custom"></span>
                            <span data-i18n="hide_identity">Masquer mon identit√© (envoyer anonymement)</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label for="message" class="form-label">
                            <span data-i18n="message_optional">Message (optionnel)</span>
                        </label>
                        <textarea 
                            id="message" 
                            name="message" 
                            class="form-textarea" 
                            rows="3"
                            maxlength="200"
                            placeholder="Ajoutez un message personnel..."></textarea>
                        <div class="form-helper">
                            <span id="messageCount">0</span>/200 <span data-i18n="characters">caract√®res</span>
                        </div>
                    </div>
                </div>

                <!-- Fee Information -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="fees_payment">Frais et paiement</h3>
                    
                    <div class="fee-breakdown">
                        <div class="fee-row">
                            <span data-i18n="subtotal">Sous-total:</span>
                            <span id="feeSubtotal">$0</span>
                        </div>
                        <div class="fee-row">
                            <span data-i18n="service_fee">Frais de service (3.5%):</span>
                            <span id="feeAmount">$0</span>
                        </div>
                        <div class="fee-row fee-total">
                            <span data-i18n="total_to_pay">Total √† payer:</span>
                            <span id="feeTotalAmount">$0</span>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="coverFees" name="coverFees" onchange="updateFees()">
                            <span class="checkbox-custom"></span>
                            <span data-i18n="cover_fees">Je prends en charge les frais (le destinataire recevra le montant complet)</span>
                        </label>
                    </div>
                </div>

                <!-- Payment Method Selection -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="payment_method">M√©thode de paiement</h3>
                    
                    <div class="payment-methods-grid">
                        <label class="payment-method-card">
                            <input type="radio" name="paymentMethod" value="flexpay" checked>
                            <span class="payment-method-content">
                                <span class="payment-method-icon">üì±</span>
                                <span class="payment-method-name">Mobile Money</span>
                                <span class="payment-method-desc">Via FlexPay</span>
                            </span>
                        </label>
						<label class="payment-method-card">
                            <input type="radio" name="paymentMethod" value="flexpaycard">
                            <span class="payment-method-content">
                                <span class="payment-method-icon">üí≥</span>
                                <span class="payment-method-name">Carte bancaire</span>
                                <span class="payment-method-desc">Via FlexPay</span>
                            </span>
                        </label>
                        
                        <!--<label class="payment-method-card">
                            <input type="radio" name="paymentMethod" value="flutterwave">
                            <span class="payment-method-content">
                                <span class="payment-method-icon">üåä</span>
                                <span class="payment-method-name">Flutterwave</span>
                                <span class="payment-method-desc">Alternative payment</span>
                            </span>
                        </label> -->
                        
                        <label class="payment-method-card">
                            <input type="radio" name="paymentMethod" value="cash">
                            <span class="payment-method-content">
                                <span class="payment-method-icon">üíµ</span>
                                <span class="payment-method-name">Cash/Western Union</span>
                                <span class="payment-method-desc">Paiement manuel</span>
                            </span>
                        </label>
                        
                        <label class="payment-method-card">
                            <input type="radio" name="paymentMethod" value="bank">
                            <span class="payment-method-content">
                                <span class="payment-method-icon">üè¶</span>
                                <span class="payment-method-name">Virement Bancaire</span>
                                <span class="payment-method-desc">Transfert bancaire</span>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                        <span data-i18n="cancel">Annuler</span>
                    </button>
                    <button type="submit" class="btn btn-primary btn-large">
                        <span data-i18n="proceed_to_payment">Proc√©der au paiement</span>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 Nimwema. <span data-i18n="all_rights">Tous droits r√©serv√©s.</span></p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="/js/i18n.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/send-voucher.js"></script>
    <script>
        function togglePassword() {
            const passwordInput = document.getElementById("senderPassword");
            const eyeIcon = document.querySelector(".eye-icon");
            
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                eyeIcon.textContent = "üôà";
            } else {
                passwordInput.type = "password";
                eyeIcon.textContent = "üëÅÔ∏è";
            }
        }
        
        // Show account fields when Cash/WU is selected
        document.addEventListener("DOMContentLoaded", function() {
            const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
            const accountFields = document.getElementById("accountFields");
            const passwordFields = document.getElementById("passwordFields");
            
            paymentMethods.forEach(method => {
                method.addEventListener("change", function() {
                    if (this.value === "cash" || this.value === "bank") {
                        accountFields.style.display = "block";
                        passwordFields.style.display = "block";
                        document.getElementById("senderEmail").required = true;
                        document.getElementById("senderPassword").required = true;
                    } else {
                        accountFields.style.display = "none";
                        passwordFields.style.display = "none";
                        document.getElementById("senderEmail").required = false;
                        document.getElementById("senderPassword").required = false;
                    }
                });
            });
        });
    </script>
<!-- Prefill from dashboard query params -->
    <script>
        (function () {
            function applyPrefillFromQuery() {
                if (!('URLSearchParams' in window)) return;

                var params = new URLSearchParams(window.location.search);
                if (!params.toString()) return;

                // 1) Sender name: accept ?senderName=... or ?name=...
                var senderNameFromParams = params.get('senderName') || params.get('sname');
                if (senderNameFromParams) {
                    var senderNameInput = document.getElementById('senderName');
                    if (senderNameInput && !senderNameInput.value) {
                        senderNameInput.value = senderNameFromParams;
                    }
                }

                // 2) Sender phone: accept ?senderPhone=... or ?phone=...
                //    Also try to prefill the first recipient phone if it exists.
                var senderPhoneFromParams = params.get('senderPhone') || params.get('sphone');
                if (senderPhoneFromParams) {
                    var senderPhoneInput = document.getElementById('senderPhone');
                    if (senderPhoneInput && !senderPhoneInput.value) {
                        senderPhoneInput.value = senderPhoneFromParams;
                    }

                    // Try to prefill first recipient phone, once send-voucher.js created it
                    var firstRecipientPhone = document.querySelector('#recipientsInputContainer input[type="tel"]');
                    var rPhoneFromParams = params.get('recipientPhone') || params.get('phone');

                    if (firstRecipientPhone && !firstRecipientPhone.value) {
                        firstRecipientPhone.value = rPhoneFromParams;
                    }
                }
else {              var firstRecipientPhone = document.querySelector('#recipientsInputContainer input[type="tel"]');
                    var rPhoneFromParams = params.get('recipientPhone') || params.get('phone');

                    if (firstRecipientPhone && !firstRecipientPhone.value) {
                        firstRecipientPhone.value = rPhoneFromParams;
                    }

}
               

                // 3) Generic fallback: param name == element id
                params.forEach(function (value, key) {
                    var el = document.getElementById(key);
                    if (el && !el.value) {
                        el.value = value;
                    }
                });
            }

            // Use window.load so /js/send-voucher.js has time to build recipient fields
            window.addEventListener('load', applyPrefillFromQuery);
        })();
    </script>
</body>
</html>