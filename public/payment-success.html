<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paiement r√©ussi - Nimwema</title>
    <meta name="description" content="Votre paiement a √©t√© trait√© avec succ√®s. Les bons d'achat ont √©t√© g√©n√©r√©s et envoy√©s par SMS.">
    
    <!-- Security Headers (for production) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://sites.super.myninja.ai; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com; font-src 'self' https://fonts.gstatic.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/forms.css">
    
    <!-- Analytics (keep for production if needed; otherwise remove) -->
    <script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js" defer></script>
</head>
<body>
    <!-- Header (coherent with app structure: logo, lang selector, auth) -->
    <header class="header">
        <div class="header-top">
            <div class="language-selector">
                <button class="lang-btn active" data-lang="fr">FR</button>
                <button class="lang-btn" data-lang="ln">LN</button>
                <button class="lang-btn" data-lang="en">EN</button>
            </div>
            <button class="login-btn" onclick="window.location.href='/login.html'">
                <span data-i18n="login">Connexion</span> / <span data-i18n="welcome">Bienvenue</span>
            </button>
        </div>
        
        <div class="header-main">
            <a href="/" class="logo">
                NIM<span class="w">W</span>EMA
            </a>
            <button class="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="section">
        <div class="container">
            <div class="confirmation-card">
                <!-- Success Icon -->
                <div class="confirmation-icon" style="background: var(--success);">
                    ‚úì
                </div>
                
                <!-- Title -->
                <h1 class="confirmation-title" data-i18n="payment_success_title">
                    Paiement r√©ussi !
                </h1>
                
                <!-- Message (coherent with backend: vouchers created/redeemed via FlexPay callback) -->
                <p class="confirmation-message" data-i18n="payment_success_message">
                    Votre paiement a √©t√© trait√© avec succ√®s via FlexPay. Les bons d'achat ont √©t√© g√©n√©r√©s, les commandes approuv√©es (status: 'paid'), et les codes uniques envoy√©s aux destinataires par SMS.
                </p>
                
                <!-- Success Details (aligned with backend flows: orders pending->paid, vouchers CRUD, metadata JSONB for recipients) -->
                <div class="card" style="text-align: left; margin-bottom: var(--space-xl);">
                    <h3 style="margin-bottom: var(--space-md);" data-i18n="what_happens_next">
                        Que se passe-t-il maintenant ?
                    </h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="padding: var(--space-sm) 0; display: flex; gap: var(--space-sm);">
                            <span style="color: var(--primary-green); font-weight: 700;">1.</span>
                            <span data-i18n="success_step_1">
                                Les bons d'achat ont √©t√© cr√©√©s avec des codes uniques et m√©tadonn√©es (JSONB) pour les destinataires
                            </span>
                        </li>
                        <li style="padding: var(--space-sm) 0; display: flex; gap: var(--space-sm);">
                            <span style="color: var(--primary-green); font-weight: 700;">2.</span>
                            <span data-i18n="success_step_2">
                                Un SMS a √©t√© envoy√© √† chaque destinataire avec son code de bon via l'endpoint /api/vouchers
                            </span>
                        </li>
                        <li style="padding: var(--space-sm) 0; display: flex; gap: var(--space-sm);">
                            <span style="color: var(--primary-green); font-weight: 700;">3.</span>
                            <span data-i18n="success_step_3">
                                Les destinataires peuvent racheter leurs bons dans nos marchands partenaires
                            </span>
                        </li>
                        <li style="padding: var(--space-sm) 0; display: flex; gap: var(--space-sm);">
                            <span style="color: var(--primary-green); font-weight: 700;">4.</span>
                            <span data-i18n="success_step_4">
                                Vous recevrez un email de confirmation ; consultez vos commandes en attente via /api/orders/my-pending si needed
                            </span>
                        </li>
                    </ul>
                </div>
                
                <!-- Actions (conditional on auth: guest vs authenticated, linking to dashboard for /api/senders, /api/requests) -->
                <div class="confirmation-actions">
                    <div id="auth-actions" style="display: none;">
                        <button class="btn btn-primary btn-large" onclick="window.location.href='/dashboard.html'">
                            <span data-i18n="view_dashboard">Voir mon tableau de bord</span>
                        </button>
                    </div>
                    <div id="guest-actions" style="display: none;">
                        <button class="btn btn-primary btn-large" onclick="window.location.href='/login.html'">
                            <span data-i18n="sign_in">Se connecter</span>
                        </button>
                        <button class="btn btn-secondary btn-large" onclick="window.location.href='/register.html'">
                            <span data-i18n="sign_up">S'inscrire</span>
                        </button>
                    </div>
                    <button class="btn btn-secondary btn-large" onclick="window.location.href='/send.html'">
                        <span data-i18n="send_another">Envoyer un autre bon</span>
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='/'">
                        <span data-i18n="back_home">Retour √† l'accueil</span>
                    </button>
                </div>
                
                <!-- Thank You Note -->
                <div style="margin-top: var(--space-xl); padding: var(--space-lg); background: var(--paper); border-radius: var(--radius-input);">
                    <p style="font-size: 16px; color: var(--grey-700); margin: 0; text-align: center;">
                        <strong>üíö Merci d'avoir utilis√© Nimwema !</strong><br>
                        <span data-i18n="thank_you_message">
                            Votre g√©n√©rosit√© fait la diff√©rence. Le bien circule, les b√©n√©dictions suivent.
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer (updated copyright for 2025) -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Nimwema. <span data-i18n="all_rights">Tous droits r√©serv√©s.</span></p>
            </div>
        </div>
    </footer>

    <!-- Scripts (defer for performance; i18n and main for coherence) -->
    <script src="/js/i18n.js" defer></script>
    <script src="/js/main.js" defer></script>
    
    <script>
        // Production-ready: Remove console.logs in prod build; use error boundaries
        // Get order ID from URL (from FlexPay redirect/callback)
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order');
        
        // Process FlexPay callback (coherent with backend: /api/flexpay/callback, but using /api/payment/flexpay/card/callback as per provided; adjust if backend path differs)
        // This simulates/triggers backend voucher creation on success (status='paid', metadata JSONB)
        async function processFlexPayCallback() {
            if (!orderId) {
                // Fallback: redirect or show error if no orderId in prod
                console.warn('No order ID found in URL params'); // Remove in prod
                return;
            }
            
            try {
                // In prod, ensure credentials: 'include' for session cookies
                const response = await fetch('/api/payment/flexpay/card/callback', {
                    method: 'POST',
                    credentials: 'include', // Ensures cookies/session sent for auth
                    headers: { 
                        'Content-Type': 'application/json',
                        // Add CSRF if implemented in backend
                    },
                    body: JSON.stringify({ 
                        reference: orderId,
                        status: 'success' // Triggers order update to 'paid', voucher gen/redeem
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Optionally update UI with dynamic data (e.g., voucher codes from result)
                    console.info('Voucher created and order approved successfully'); // Remove in prod
                } else {
                    throw new Error(result.message || 'Callback processing failed');
                }
            } catch (error) {
                console.error('Error processing FlexPay callback:', error); // Log to service like Sentry in prod
                // In prod: show user-friendly toast/error modal instead of console
                alert('Une erreur est survenue lors du traitement. Veuillez contacter le support.'); // Temp; replace with UI
            }
        }
        
        // Check authentication status (coherent with backend auth: cookie/session DB check)
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status', {
                    credentials: 'include' // For session cookie
                });
                
                if (!response.ok) {
                    throw new Error(`Auth check failed: ${response.status}`);
                }
                
                const result = await response.json();
                
                const authActions = document.getElementById('auth-actions');
                const guestActions = document.getElementById('guest-actions');
                
                if (result.authenticated && result.user) {
                    // Optionally personalize: e.g., greet user.role (guest/user)
                    authActions.style.display = 'block';
                    guestActions.style.display = 'none';
                } else {
                    guestActions.style.display = 'block';
                    authActions.style.display = 'none';
                }
            } catch (error) {
                console.warn('Auth check failed, defaulting to guest options:', error); // Remove in prod
                document.getElementById('guest-actions').style.display = 'block';
            }
        }
        
        // Init on DOM load (for perf)
        document.addEventListener('DOMContentLoaded', () => {
           // if (orderId) {
             //   processFlexPayCallback();
            //}
            checkAuthStatus();
        });
    </script>
</body>
</html>