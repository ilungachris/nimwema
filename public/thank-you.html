<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dire Merci - Nimwema</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/layout.css">
    <style>
        .thank-you-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .thank-you-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .thank-you-header h1 {
            color: #111111;
            font-size: 28px;
            margin-bottom: 10px;
        }
        .thank-you-header p {
            color: #666;
            font-size: 14px;
        }
        .thank-you-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #111111;
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            box-sizing: border-box;
        }
        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #8BC34A;
        }
        .char-count {
            text-align: right;
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: #8BC34A;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        .submit-btn:hover { background: #7CB342; }
        .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .alert.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .info-box p {
            margin: 0;
            font-size: 13px;
            color: #666;
        }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.active { display: block; }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8BC34A;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Layout Placeholders -->
    <div id="app-header"></div>
    <div id="app-mobile-nav"></div>

    <main>
        <div class="thank-you-container">
            <div class="thank-you-header">
                <div class="thank-you-icon">üôè</div>
                <h1>Dire Merci</h1>
                <p>Envoyez un message de remerciement √† votre bienfaiteur</p>
            </div>

            <div id="alertBox" class="alert"></div>

            <div class="loading" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Envoi en cours...</p>
            </div>

            <div class="info-box">
                <p>üí° Votre message de remerciement sera envoy√© par SMS √† la personne qui vous a envoy√© le bon.</p>
            </div>

            <form id="thankYouForm">
                <div class="form-group">
                    <label for="recipientName">Votre nom *</label>
                    <input type="text" id="recipientName" name="recipientName" required>
                </div>

                <div class="form-group">
                    <label for="recipientPhone">Votre t√©l√©phone *</label>
                    <input type="tel" id="recipientPhone" name="recipientPhone" placeholder="+243XXXXXXXXX" required>
                </div>

                <div class="form-group">
                    <label for="senderPhone">T√©l√©phone du bienfaiteur *</label>
                    <input type="tel" id="senderPhone" name="senderPhone" placeholder="+243XXXXXXXXX" required>
                </div>

                <div class="form-group">
                    <label for="thankYouMessage">Message de remerciement *</label>
                    <textarea id="thankYouMessage" name="thankYouMessage" maxlength="500" required>Bonjour,

Je tiens √† vous remercier du fond du c≈ìur pour le bon d'achat que vous m'avez envoy√© via Nimwema. Votre g√©n√©rosit√© et votre soutien signifient beaucoup pour moi et ma famille.

Gr√¢ce √† votre aide, j'ai pu subvenir √† mes besoins essentiels. Votre geste de solidarit√© ne sera pas oubli√©.

Que Dieu vous b√©nisse abondamment.

Merci encore!</textarea>
                    <div class="char-count">
                        <span id="charCount">0</span>/500 caract√®res
                    </div>
                </div>

                <button type="submit" class="submit-btn">Envoyer le message de remerciement</button>
            </form>
        </div>
    </main>

    <!-- Footer Placeholder -->
    <div id="app-footer"></div>

    <script src="/js/i18n.js"></script>
    <script src="/js/layout.js"></script>
    <script>
        NimwemaLayout.init({ activePage: 'thank-you' });

        const urlParams = new URLSearchParams(window.location.search);
        const voucherCode = urlParams.get('code');

        const messageTextarea = document.getElementById('thankYouMessage');
        const charCount = document.getElementById('charCount');

        function updateCharCount() {
            charCount.textContent = messageTextarea.value.length;
        }
        messageTextarea.addEventListener('input', updateCharCount);
        updateCharCount();

        async function loadVoucherInfo() {
            if (voucherCode) {
                try {
                    const response = await fetch(`/api/vouchers/${voucherCode}`);
                    if (response.ok) {
                        const voucher = await response.json();
                        document.getElementById('senderPhone').value = voucher.senderPhone || '';
                        document.getElementById('recipientPhone').value = voucher.recipientPhone || '';
                    }
                } catch (error) {
                    console.error('Error loading voucher info:', error);
                }
            }
        }
        loadVoucherInfo();

        document.getElementById('thankYouForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                recipientName: document.getElementById('recipientName').value.trim(),
                recipientPhone: document.getElementById('recipientPhone').value.trim(),
                senderPhone: document.getElementById('senderPhone').value.trim(),
                message: document.getElementById('thankYouMessage').value.trim(),
                voucherCode: voucherCode
            };

            const phoneRegex = /^\+243[0-9]{9}$/;
            if (!phoneRegex.test(formData.recipientPhone)) {
                showAlert('Num√©ro de t√©l√©phone du destinataire invalide. Format: +243XXXXXXXXX', 'error');
                return;
            }
            if (!phoneRegex.test(formData.senderPhone)) {
                showAlert('Num√©ro de t√©l√©phone du bienfaiteur invalide. Format: +243XXXXXXXXX', 'error');
                return;
            }

            document.getElementById('loadingSpinner').classList.add('active');
            document.getElementById('thankYouForm').style.display = 'none';

            try {
                const response = await fetch('/api/thank-you/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('‚úÖ Votre message de remerciement a √©t√© envoy√© avec succ√®s !', 'success');
                    setTimeout(() => {
                        document.getElementById('thankYouForm').reset();
                        updateCharCount();
                        document.getElementById('loadingSpinner').classList.remove('active');
                        document.getElementById('thankYouForm').style.display = 'block';
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Erreur lors de l\'envoi du message');
                }
            } catch (error) {
                showAlert(error.message, 'error');
                document.getElementById('loadingSpinner').classList.remove('active');
                document.getElementById('thankYouForm').style.display = 'block';
            }
        });

        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert ${type}`;
            alertBox.style.display = 'block';
            setTimeout(() => { alertBox.style.display = 'none'; }, 5000);
        }
    </script>
</body>
</html>
