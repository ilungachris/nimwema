<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envoyer un bon d'achat - Nimwema</title>
    <meta name="description" content="Envoyez un bon d'achat alimentaire via Nimwema">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/send.css">
    <link rel="stylesheet" href="/css/flexpay-popup.css">
    <link rel="stylesheet" href="/css/layout.css">
</head>
<body>
    <!-- Layout Placeholders -->
    <div id="app-header"></div>
    <div id="app-mobile-nav"></div>

    <!-- Main Content -->
    <main class="section">
        <div class="container container-narrow">
            <!-- Page Header -->
            <div class="page-header">
                <h1 data-i18n="send_voucher_title">Envoyer un bon d'achat</h1>
                <p class="text-small" data-i18n="send_voucher_subtitle">
                    Choisissez le montant et envoyez un bon d'achat √† vos proches
                </p>
            </div>

            <!-- Send Form -->
            <form id="sendVoucherForm" class="form-card">
                <!-- Currency Selection -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="currency_selection">Devise</h3>
                    
                    <div class="currency-selector-group">
                        <button type="button" class="currency-btn active" data-currency="USD" onclick="selectCurrency('USD')">
                            <span class="currency-symbol">$</span>
                            <span class="currency-name">USD</span>
                        </button>
                        <button type="button" class="currency-btn" data-currency="CDF" onclick="selectCurrency('CDF')">
                            <span class="currency-symbol">FC</span>
                            <span class="currency-name">CDF</span>
                        </button>
                    </div>
                    
                    <div class="exchange-rate-display" id="exchangeRateDisplay">
                        <small data-i18n="exchange_rate">Taux de change:</small>
                        <strong id="exchangeRateText">1 USD = 2,800 CDF</strong>
                    </div>
                </div>

                <!-- Amount Selection -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="amount_selection">Montant</h3>
                    
                    <div class="amount-preset-grid" id="amountPresetGrid">
                        <!-- Preset buttons will be generated by JavaScript -->
                    </div>
                    
                    <div class="form-group">
                        <label for="customAmount" class="form-label">
                            <span data-i18n="custom_amount">Montant personnalis√©</span>
                        </label>
                        <div class="amount-input-group">
                            <span class="amount-currency" id="amountCurrencySymbol">$</span>
                            <input 
                                type="number" 
                                id="customAmount" 
                                name="customAmount" 
                                class="form-input amount-input"
                                min="1"
                                step="1"
                                placeholder="0">
                            <span class="amount-equivalent" id="amountEquivalent"></span>
                        </div>
                        <div class="form-helper" data-i18n="amount_helper_send">
                            S√©lectionnez un montant pr√©d√©fini ou entrez un montant personnalis√©
                        </div>
                    </div>
                </div>

                <!-- Quantity Selection -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="quantity_selection">Quantit√©</h3>
                    
                    <div class="form-group">
                        <label for="quantity" class="form-label">
                            <span data-i18n="number_of_vouchers">Nombre de bons</span>
                            <span class="required">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="quantity" 
                            name="quantity" 
                            class="form-input" 
                            required
                            min="1"
                            max="50"
                            value="1"
                            onchange="updateTotalAmount()">
                        <div class="form-helper" data-i18n="quantity_helper">
                            Nombre de bons d'achat √† cr√©er (maximum 50)
                        </div>
                    </div>
                    
                    <div class="total-amount-display">
                        <div class="total-label" data-i18n="total_amount">Montant total:</div>
                        <div class="total-value" id="totalAmountDisplay">$0</div>
                    </div>
                </div>

                <!-- Recipients Selection -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="recipients_selection">Destinataires</h3>
                    
                    <div class="radio-group">
                        <!-- From Waiting List -->
                        <label class="radio-label">
                            <input 
                                type="radio" 
                                name="recipientType" 
                                value="waiting_list"
                                onchange="toggleRecipientFields()">
                            <span class="radio-custom"></span>
                            <span class="radio-text">
                                <strong data-i18n="from_waiting_list">Depuis la liste d'attente</strong>
                                <small data-i18n="from_waiting_list_desc">Choisir des demandes en attente</small>
                            </span>
                        </label>

                        <!-- Specific Recipients -->
                        <label class="radio-label">
                            <input 
                                type="radio" 
                                name="recipientType" 
                                value="specific"
                                checked
                                onchange="toggleRecipientFields()">
                            <span class="radio-custom"></span>
                            <span class="radio-text">
                                <strong data-i18n="specific_recipients">Destinataires sp√©cifiques</strong>
                                <small data-i18n="specific_recipients_desc">Entrer les num√©ros de t√©l√©phone</small>
                            </span>
                        </label>
                    </div>

                    <!-- Waiting List Container (Hidden by default) -->
                    <div id="waitingListSection" class="hidden">
                        <div id="waitingListContainer">
                            <div class="loading-state">
                                <p>Chargement de la liste d'attente...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Specific Recipients Container -->
                    <div id="specificRecipientsSection">
                        <div id="recipientsInputContainer">
                            <!-- Recipient inputs will be generated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Sender Information -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="sender_info">Vos informations</h3>
                    
                    <div class="form-group">
                        <label for="senderName" class="form-label">
                            <span data-i18n="your_name">Votre nom</span>
                        </label>
                        <input 
                            type="text" 
                            id="senderName" 
                            name="senderName" 
                            class="form-input"
                            placeholder="Votre nom (optionnel)">
                    </div>
                    
                    <div class="form-group">
                        <label for="senderPhone" class="form-label">
                            <span data-i18n="your_phone">Votre t√©l√©phone</span>
                        </label>
                        <input 
                            type="tel" 
                            id="senderPhone" 
                            name="senderPhone" 
                            class="form-input"
                            placeholder="+243 XXX XXX XXX">
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="anonymous" name="anonymous">
                            <span class="checkbox-custom"></span>
                            <span data-i18n="stay_anonymous">Rester anonyme aupr√®s du b√©n√©ficiaire</span>
                        </label>
                    </div>
                </div>

                <!-- Payment Method Selection -->
                <div class="form-section">
                    <h3 class="form-section-title" data-i18n="payment_method">M√©thode de paiement</h3>
                    
                    <div class="payment-methods-grid">
                        <label class="payment-method-card">
                            <input type="radio" name="paymentMethod" value="flexpay" checked>
                            <span class="payment-method-content">
                                <span class="payment-method-icon">üì±</span>
                                <span class="payment-method-name">Mobile Money</span>
                                <span class="payment-method-desc">M-Pesa, Airtel Money, Orange</span>
                            </span>
                        </label>
                        
                        <label class="payment-method-card">
                            <input type="radio" name="paymentMethod" value="cash">
                            <span class="payment-method-content">
                                <span class="payment-method-icon">üíµ</span>
                                <span class="payment-method-name">Cash/Western Union</span>
                                <span class="payment-method-desc">Paiement manuel</span>
                            </span>
                        </label>
                        
                        <label class="payment-method-card">
                            <input type="radio" name="paymentMethod" value="bank">
                            <span class="payment-method-content">
                                <span class="payment-method-icon">üè¶</span>
                                <span class="payment-method-name">Virement Bancaire</span>
                                <span class="payment-method-desc">Transfert bancaire</span>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                        <span data-i18n="cancel">Annuler</span>
                    </button>
                    <button type="submit" class="btn btn-primary btn-large">
                        <span data-i18n="proceed_to_payment">Proc√©der au paiement</span>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- Footer Placeholder -->
    <div id="app-footer"></div>

    <!-- Scripts -->
    <script src="/js/i18n.js"></script>
    <script src="/js/layout.js"></script>
    <script src="/js/send-voucher.js"></script>
    <script>
        NimwemaLayout.init({ activePage: 'send' });
    </script>
    <script>
        // Check for resumed order after login
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('resume') === 'true') {
                const pendingOrder = sessionStorage.getItem('pendingVoucherOrder');
                if (pendingOrder) {
                    setTimeout(async function() {
                        try {
                            const formData = JSON.parse(pendingOrder);
                            const overlay = document.createElement('div');
                            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999';
                            overlay.innerHTML = '<div style="background:#fff;padding:24px 28px;border-radius:10px;text-align:center"><div style="width:40px;height:40px;border:4px solid #eee;border-top:4px solid #8BC34A;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px"></div><div>Cr√©ation de votre commande...</div><style>@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}</style></div>';
                            document.body.appendChild(overlay);
                            
                            const response = await fetch('/api/vouchers/create-pending', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formData)
                            });
                            
                            const result = await response.json();
                            
                            if (response.ok && result.success) {
                                sessionStorage.removeItem('pendingVoucherOrder');
                                sessionStorage.setItem('pendingOrder', JSON.stringify(result.order));
                                window.location.href = '/payment-instructions.html';
                            } else {
                                throw new Error(result.message || 'Erreur lors de la cr√©ation');
                            }
                        } catch (error) {
                            console.error('Error resuming order:', error);
                            sessionStorage.removeItem('pendingVoucherOrder');
                            alert('Erreur lors de la cr√©ation de votre commande. Veuillez r√©essayer.');
                            window.history.replaceState({}, document.title, '/send.html');
                        }
                    }, 500);
                }
            }
        });
    </script>
    <script>
        (function () {
            function applyPrefillFromQuery() {
                if (!('URLSearchParams' in window)) return;
                var params = new URLSearchParams(window.location.search);
                if (!params.toString()) return;

                var senderNameFromParams = params.get('senderName') || params.get('sname');
                if (senderNameFromParams) {
                    var senderNameInput = document.getElementById('senderName');
                    if (senderNameInput && !senderNameInput.value) {
                        senderNameInput.value = senderNameFromParams;
                    }
                }

                var senderPhoneFromParams = params.get('senderPhone') || params.get('sphone');
                if (senderPhoneFromParams) {
                    var senderPhoneInput = document.getElementById('senderPhone');
                    if (senderPhoneInput && !senderPhoneInput.value) {
                        senderPhoneInput.value = senderPhoneFromParams;
                    }
                }

                var firstRecipientPhone = document.querySelector('#recipientsInputContainer input[type="tel"]');
                var rPhoneFromParams = params.get('recipientPhone') || params.get('phone');
                if (firstRecipientPhone && !firstRecipientPhone.value && rPhoneFromParams) {
                    firstRecipientPhone.value = rPhoneFromParams;
                }

                params.forEach(function (value, key) {
                    var el = document.getElementById(key);
                    if (el && !el.value) {
                        el.value = value;
                    }
                });
            }
            window.addEventListener('load', applyPrefillFromQuery);
        })();
    </script>
</body>
</html>
